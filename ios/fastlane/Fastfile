default_platform(:ios)

platform :ios do
  desc "Push a new beta build to TestFlight"
  lane :beta do
    # Try API key first, fall back to Apple ID auth
    api_key = nil

    if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] && ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"] && ENV["APP_STORE_CONNECT_API_KEY_KEY"]
      puts "Using App Store Connect API key authentication"
      api_key = app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
        is_key_content_base64: true,
        in_house: false
      )
    else
      puts "No API key found, using Apple ID authentication"
      puts "You may be prompted for your Apple ID credentials"
    end

    # Get latest build number and increment
    if api_key
      latest_build = latest_testflight_build_number(api_key: api_key)
    else
      latest_build = latest_testflight_build_number
    end
    new_build_number = latest_build + 1

    puts "Latest TestFlight build: #{latest_build}"
    puts "New build number: #{new_build_number}"

    # Increment build number in Xcode project
    increment_build_number(
      build_number: new_build_number,
      xcodeproj: "Runner.xcodeproj"
    )

    # NOTE: Build the IPA manually first with:
    # flutter build ipa --release \
    #   --dart-define=SUPABASE_URL=https://lwyuwxqwshflmuefxgay.supabase.co \
    #   --dart-define=SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3eXV3eHF3c2hmbG11ZWZ4Z2F5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzA5MTgsImV4cCI6MjA4MTQwNjkxOH0.Ias3yQUV8p7D825WwBI08Njry4aQ_OiMkrQRGfwl7zw \
    #   --dart-define=GOOGLE_PLACES_API_KEY=AIzaSyBCkxTR7keDd_gXjXOrj8pptvboMUfg-3Q \
    #   --export-options-plist=ios/ExportOptions.plist

    # Upload to TestFlight
    if api_key
      upload_to_testflight(
        api_key: api_key,
        ipa: "../build/ios/ipa/LumoFit.ipa",
        skip_waiting_for_build_processing: true
      )
    else
      upload_to_testflight(
        ipa: "../build/ios/ipa/LumoFit.ipa",
        skip_waiting_for_build_processing: true
      )
    end

    puts "Successfully uploaded build #{new_build_number} to TestFlight!"
  end

  desc "Build IPA and push to TestFlight"
  lane :beta_with_build do
    # Get latest build number and increment
    latest_build = latest_testflight_build_number
    new_build_number = latest_build + 1

    increment_build_number(
      build_number: new_build_number,
      xcodeproj: "Runner.xcodeproj"
    )

    # Build the Flutter app
    sh "cd ../.. && flutter build ipa --release \
      --dart-define=SUPABASE_URL=https://lwyuwxqwshflmuefxgay.supabase.co \
      --dart-define=SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3eXV3eHF3c2hmbG11ZWZ4Z2F5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzA5MTgsImV4cCI6MjA4MTQwNjkxOH0.Ias3yQUV8p7D825WwBI08Njry4aQ_OiMkrQRGfwl7zw \
      --dart-define=GOOGLE_PLACES_API_KEY=AIzaSyBCkxTR7keDd_gXjXOrj8pptvboMUfg-3Q \
      --export-options-plist=ios/ExportOptions.plist"

    # Upload to TestFlight
    upload_to_testflight(
      ipa: "../build/ios/ipa/LumoFit.ipa",
      skip_waiting_for_build_processing: true
    )

    puts "Successfully uploaded build #{new_build_number} to TestFlight!"
  end

  desc "Push a new release build to App Store"
  lane :release do
    # Try API key first, fall back to Apple ID auth
    api_key = nil

    if ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"] && ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"] && ENV["APP_STORE_CONNECT_API_KEY_KEY"]
      puts "Using App Store Connect API key authentication"
      api_key = app_store_connect_api_key(
        key_id: ENV["APP_STORE_CONNECT_API_KEY_KEY_ID"],
        issuer_id: ENV["APP_STORE_CONNECT_API_KEY_ISSUER_ID"],
        key_content: ENV["APP_STORE_CONNECT_API_KEY_KEY"],
        is_key_content_base64: true,
        in_house: false
      )
    else
      puts "No API key found, using Apple ID authentication"
    end

    # Get latest build number and increment
    if api_key
      latest_build = app_store_build_number(api_key: api_key)
    else
      latest_build = app_store_build_number
    end
    new_build_number = latest_build + 1

    # Increment build number in Xcode project
    increment_build_number(
      build_number: new_build_number,
      xcodeproj: "Runner.xcodeproj"
    )

    # Build the Flutter app
    sh "cd ../.. && flutter build ipa --release \
      --dart-define=SUPABASE_URL=https://lwyuwxqwshflmuefxgay.supabase.co \
      --dart-define=SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx3eXV3eHF3c2hmbG11ZWZ4Z2F5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4MzA5MTgsImV4cCI6MjA4MTQwNjkxOH0.Ias3yQUV8p7D825WwBI08Njry4aQ_OiMkrQRGfwl7zw \
      --dart-define=GOOGLE_PLACES_API_KEY=AIzaSyBCkxTR7keDd_gXjXOrj8pptvboMUfg-3Q \
      --export-options-plist=ios/ExportOptions.plist"

    # Upload to App Store
    if api_key
      upload_to_app_store(
        api_key: api_key,
        ipa: "../build/ios/ipa/LumoFit.ipa",
        skip_screenshots: true,
        skip_metadata: true,
        precheck_include_in_app_purchases: false
      )
    else
      upload_to_app_store(
        ipa: "../build/ios/ipa/LumoFit.ipa",
        skip_screenshots: true,
        skip_metadata: true,
        precheck_include_in_app_purchases: false
      )
    end

    puts "Successfully uploaded build #{new_build_number} to App Store!"
  end
end
